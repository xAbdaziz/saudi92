var gdjs;(function(v){const o=new v.Logger("Leaderboards");let M;(function(T){let j;(function(i){const x=t=>{const e=new jsSHA("SHA-256","TEXT",{encoding:"UTF8"});return e.update(t),e.getHash("B64")};class N{constructor(){this.lastScoreSavingStartedAt=null,this.lastScoreSavingSucceededAt=null,this.currentlySavingScore=null,this.currentlySavingPlayerName=null,this.lastSavedScore=null,this.lastSavedPlayerName=null,this.lastSaveError=null,this.isScoreSaving=!1,this.hasScoreBeenSaved=!1,this.hasScoreSavingErrored=!1}isSameAsLastScore(e,n){return this.lastSavedPlayerName===e&&this.lastSavedScore===n}isAlreadySavingThisScore(e,n){return this.isScoreSaving&&this.currentlySavingPlayerName===e&&this.currentlySavingScore===n}isTooSoonToSaveAnotherScore(){return!!this.lastScoreSavingSucceededAt&&Date.now()-this.lastScoreSavingSucceededAt<500}startSaving(e,n){this.lastScoreSavingStartedAt=Date.now(),this.isScoreSaving=!0,this.hasScoreBeenSaved=!1,this.hasScoreSavingErrored=!1,this.currentlySavingScore=n,this.currentlySavingPlayerName=e}closeSaving(){this.lastScoreSavingSucceededAt=Date.now(),this.lastSavedScore=this.currentlySavingScore,this.lastSavedPlayerName=this.currentlySavingPlayerName,this.isScoreSaving=!1,this.hasScoreBeenSaved=!0}setError(e){this.lastSaveError=e,this.isScoreSaving=!1,this.hasScoreBeenSaved=!1,this.hasScoreSavingErrored=!0}}let l={},p,s=null,I=!1,m=!1,f=!1,y=null,b=null;const c=document.createElement("div");c.style.backgroundColor="#000000",c.style.display="flex",c.style.height="100%",c.style.width="100%",c.style.justifyContent="center",c.style.alignItems="center",c.style.position="relative",c.style.zIndex="2";const w=document.createElement("img");w.setAttribute("width","50px"),w.setAttribute("src","data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGZpbGw9Im5vbmUiIHZpZXdCb3g9IjAgMCAyNCAyNCI+CjxjaXJjbGUgb3BhY2l0eT0nMC4yNScgY3g9IjEyIiBjeT0iMTIiIHI9IjEwIiBzdHJva2U9IiNGRkZGRkYiIHN0cm9rZS13aWR0aD0iNCI+PC9jaXJjbGU+CjxwYXRoIG9wYWNpdHk9JzAuNzUnIGZpbGw9IiNGRkZGRkYiIGQ9Ik00IDEyYTggOCAwIDAxOC04VjBDNS4zNzMgMCAwIDUuMzczIDAgMTJoNHptMiA1LjI5MUE3Ljk2MiA3Ljk2MiAwIDAxNCAxMkgwYzAgMy4wNDIgMS4xMzUgNS44MjQgMyA3LjkzOGwzLTIuNjQ3eiI+PC9wYXRoPgo8L3N2Zz4=");try{w.animate([{transform:"rotate(0deg)"},{transform:"rotate(359deg)"}],{duration:3e3,iterations:1/0})}catch{o.warn("Animation not supported, loader will be fixed.")}c.appendChild(w);const E=function({hasSucceeded:t}){const e=r=>t?r.lastScoreSavingSucceededAt:r.lastScoreSavingStartedAt,n=Object.values(l).filter(r=>!!e(r));if(n.length===0)return null;let a=n[0];return n.forEach(r=>{const g=e(r),u=e(a);g&&u&&g>u&&(a=r)}),a};i.savePlayerScore=function(t,e,n,a){let r;if(l[e]){if(r=l[e],r.isAlreadySavingThisScore(a,n)){o.warn("There is already a request to save with this player name and this score. Ignoring this one.");return}if(r.isSameAsLastScore(a,n)){o.warn("The player and score to be sent are the same as previous one. Ignoring this one.");const d="SAME_AS_PREVIOUS";r.setError(d);return}if(r.isTooSoonToSaveAnotherScore()){o.warn("Last entry was sent too little time ago. Ignoring this one.");const d="TOO_FAST";r.setError(d);return}}else r=new N,l[e]=r;r.startSaving(a,n);const g="https://api.gdevelop-app.com/play",u=t.getGame(),C=JSON.stringify({playerName:i.formatPlayerName(a),score:n,sessionId:u.getSessionId(),clientPlayerId:u.getPlayerId(),location:typeof window!="undefined"&&window.location?window.location.href:""});fetch(`${g}/game/${v.projectData.properties.projectUuid}/leaderboard/${e}/entry`,{body:C,method:"POST",headers:{"Content-Type":"application/json",Digest:x(C)}}).then(d=>{if(!d.ok){const S=d.status.toString();o.error("Server responded with an error:",S,d.statusText),r.setError(S);return}return r.closeSaving(),d.text().then(S=>{},S=>{o.warn("An error occurred when reading response but score has been saved:",S)})},d=>{o.error("Error while submitting a leaderboard score:",d);const S="REQUEST_NOT_SENT";r.setError(S)})},i.isSaving=function(t){if(t)return l[t]?l[t].isScoreSaving:!1;const e=E({hasSucceeded:!1});return e?e.isScoreSaving:!1},i.hasBeenSaved=function(t){if(t)return l[t]?l[t].hasScoreBeenSaved:!1;const e=E({hasSucceeded:!0});return e?e.hasScoreBeenSaved:!1},i.hasSavingErrored=function(t){if(t)return l[t]?l[t].hasScoreSavingErrored:!1;const e=E({hasSucceeded:!1});return e?e.hasScoreSavingErrored:!1},i.getLastSaveError=function(t){if(t)return l[t]?l[t].lastSaveError:"NO_DATA_ERROR";const e=E({hasSucceeded:!1});return e?e.lastSaveError:"NO_DATA_ERROR"},i.formatPlayerName=function(t){return!t||typeof t!="string"||typeof t=="string"&&t.length===0?`Player${Math.round((Math.random()*9+1)*1e4)}`:t.trim().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s/g,"_").replace(/[^\w|-]/g,"").slice(0,30)};const O=function(t){return fetch(t,{method:"GET",headers:{"Content-Type":"application/json"}}).then(e=>e.ok?!0:(o.error(`Error while fetching leaderboard view, server returned: ${e.status} ${e.statusText}`),!1),e=>(o.error("Error while fetching leaderboard view:",e),!1))},P=function(t,e,n){switch(n.data){case"closeLeaderboardView":i.closeLeaderboardView(t);break;case"leaderboardViewLoaded":if(e&&(y&&clearTimeout(y),A(!1,t,{callOnErrorIfDomElementContainerMissing:!1})),!s){h(t,"The leaderboard view couldn't be found. Doing nothing.");return}s.style.opacity="1",f=!0,m=!1;break}},h=function(t,e){o.error(e),I=!0,m=!1,i.closeLeaderboardView(t)},L=t=>{y&&clearTimeout(y),y=setTimeout(()=>{f||h(t,"Leaderboard page did not send message in time. Closing leaderboard view.")},5e3)},A=function(t,e,n){const a=e.getGame().getRenderer().getDomElementContainer();if(!a)return n.callOnErrorIfDomElementContainerMissing&&h(e,"The div element covering the game couldn't be found, the leaderboard cannot be displayed."),!1;if(t)a.children&&a.children.length>0?a.insertBefore(c,a.children[0]):a.appendChild(c),s&&(s.style.opacity="0");else try{a.removeChild(c),s&&(s.style.opacity="1")}catch{}return!0},G=function(t){const e=document.createElement("iframe");return e.src=t,e.id="leaderboard-view",e.style.position="absolute",e.style.opacity="0",e.style.pointerEvents="all",e.style.backgroundColor="#FFFFFF",e.style.top="0px",e.style.height="100%",e.style.left="0px",e.style.width="100%",e.style.border="none",e};i.displayLeaderboard=function(t,e,n){if(e===p){if(m){o.warn(`Already loading the view for the requested loader (${e}), ignoring.`);return}if(f){o.warn(`Already loaded the view for the requested loader (${e}), ignoring.`);return}}p=e,I=!1,f=!1,m=!0,n&&A(!0,t,{callOnErrorIfDomElementContainerMissing:!0});const r=`https://liluo.io/games/${v.projectData.properties.projectUuid}/leaderboard/${e}?inGameEmbedded=true`;O(r).then(g=>{if(e!==p){o.warn(`Received a response for leaderboard ${e} though the last leaderboard requested is ${p}, ignoring this response.`);return}if(!g){h(t,"Leaderboard data could not be fetched. Closing leaderboard view if there is one.");return}if(s)L(t),n&&A(!0,t,{callOnErrorIfDomElementContainerMissing:!1}),s.src=r;else{const u=t.getGame().getRenderer().getDomElementContainer();if(!u){h(t,"The div element covering the game couldn't be found, the leaderboard cannot be displayed.");return}L(t),s=G(r),typeof window!="undefined"&&(b=C=>{P(t,n,C)},window.addEventListener("message",b,!0)),u.appendChild(s)}},g=>{o.error(g),h(t,"An error occurred when fetching leaderboard data. Closing leaderboard view if there is one.")})},i.isLeaderboardViewErrored=function(){return I},i.isLeaderboardViewLoaded=function(){return f},i.isLeaderboardViewLoading=function(){return m},i.closeLeaderboardView=function(t){try{if(A(!1,t,{callOnErrorIfDomElementContainerMissing:!1}),!s){o.info("The iframe displaying the current leaderboard couldn't be found, the leaderboard view must be already closed.");return}const e=t.getGame().getRenderer().getDomElementContainer();if(!e){o.info("The div element covering the game couldn't be found, the leaderboard view must be already closed.");return}typeof window!="undefined"&&(window.removeEventListener("message",b,!0),b=null),e.removeChild(s),s=null}finally{f=!1;const e=t.getGame().getRenderer().getCanvas();e&&e.focus()}}})(j=T.leaderboards||(T.leaderboards={}))})(M=v.evtTools||(v.evtTools={}))})(gdjs||(gdjs={}));
//# sourceMappingURL=leaderboardstools.js.map
